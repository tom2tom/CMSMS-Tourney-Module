/*!
SSsort table-sorter/pager plug-in for JQuery
Version 0.4
Copyright (C) 2014-2015 Tom Phane
Licensed under the GNU Affero GPL v.3 or, at the distributor's discretion, a later version.
See http://www.gnu.org/licenses#AGPL.
*/
(function($){$.extend({SSsort:new function(){function d(i){i.pagecount=((i.rows.length/i.pagesize)|0)+1}function c(k,j){var o=parseInt(j.pagesize,10);if(j.currentid){if(o<1){j.currentpage=1}else{j.currentpage=((k/o)|0)+1}$("#"+j.currentid).html(j.currentpage)}var n=j.rows;if(o<1){o=n.length+1}var m=k+o;for(var l=0;l<n.length;l++){n[l].style.display=(l>=k&&l<m)?"":"none"}}function e(s){var m=s.works[s.sortcol];var j=m.parser.format;var u=s.rows;var q=u.length;var t=s.sortcol;var o=[];var n;for(var r=0;r<q;r++){n=u[r].cells[t];o[r]=[j(b(n),n,s),r]}var k;if(m.parser.type=="text"){k=(s.sortdesc)?function(l,i){return(i[0].localeCompare(l[0]))}:function(l,i){return(l[0].localeCompare(i[0]))}}else{k=(s.sortdesc)?function(l,i){return(i[0]-l[0])}:function(l,i){return(l[0]-i[0])}}m._map=o.sort(k)}function h(r){var j=$(this).closest("table");var o=$.data(j[0],"SSsortcfg");if(o.rows.length<2){return}var m=this.cellIndex;var w=o.header.find("tr:first > th");var k=0;if(m>0){for(var n=0;n<m;n++){var v=w[n];if(v.hasAttribute("colspan")){var u=v.getAttribute("colspan");k+=parseInt(u,10)||1}else{k++}}}var s=null;if(k==o.sortcol){var q=(o.sortdesc)?o.descClass:o.ascClass;o.sortdesc=!o.sortdesc;var t=(o.sortdesc)?o.descClass:o.ascClass;if(q){w.eq(k).removeClass(q)}if(t){w.eq(k).addClass(t)}$(o.table).trigger("beforetablesort",{column:k,direction:o.sortdesc});if(o.works[k].dirty){e(o)}else{o.works[k]._map.reverse()}}else{if(o.sortcol!==null){s=o.sortcol;q=(o.sortdesc)?o.descClass:o.ascClass;if(q){w.eq(s).removeClass(q)}if(o.sortClass){w.eq(s).addClass(o.sortClass)}if(o.ascClass){w.eq(k).addClass(o.ascClass)}o.sortdesc=false}else{if(o.sortClass){w.eq(k).removeClass(o.sortClass)}t=(o.sortdesc)?o.descClass:o.ascClass;if(t){w.eq(k).addClass(t)}}o.sortcol=k;$(o.table).trigger("beforetablesort",{column:k,direction:o.sortdesc});e(o)}setTimeout(function(){var D=(o.oddClass)?new RegExp("(^|\\s+)"+o.oddClass+"(?!\\S)"):false;var H=(o.evenClass)?new RegExp("(^|\\s+)"+o.evenClass+"(?!\\S)"):false;var G=(o.oddClass)?new RegExp("(^|\\s+)"+o.oddsortClass+"(?!\\S)"):false;var x=(o.evenClass)?new RegExp("(^|\\s+)"+o.evensortClass+"(?!\\S)"):false;var E=o.body[0];var I=E.parentNode;var L=E.nextSibling;var K=o.rows;var z=K.length;var y=o.works[k]._map;var J,F,B,A;I.removeChild(E);for(var C=0;C<z;C++){B=y[C][1];J=K[B];v=J.cells[k];E.appendChild(J);if(C%2){if(D){J.className=J.className.replace(D,"")}if(H&&!J.className.match(H)){J.className=J.className+" "+o.evenClass}if(G){v.className=v.className.replace(G,"")}if(x&&!v.className.match(x)){v.className=v.className+" "+o.evensortClass}}else{if(H){J.className=J.className.replace(H,"")}if(D&&!J.className.match(D)){J.className=J.className+" "+o.oddClass}if(x){v.className=v.className.replace(x,"")}if(G&&!v.className.match(G)){v.className=v.className+" "+o.oddsortClass}}if(s!==null){F=J.cells[s];if(G){F.className=F.className.replace(G,"")}if(x){F.className=F.className.replace(x,"")}}y[C][1]=C;for(A=C+1;A<z;A++){if(y[A][1]>B){y[A][1]--}}}I.insertBefore(E,L);o.body=$(o.table).children("tbody");o.rows=E.rows;o.works[k].dirty=(typeof(o.works[k].parser.watch)!=="undefined"&&o.works[k].parser.watch);if(o.paginate){o.currentpage=1;d(o);c(0,o);if(o.countid){$("#"+o.countid).html(o.pagecount)}}$(o.table).trigger("aftertablesort",{column:k,direction:o.sortdesc});$.isFunction(o.onSorted)&&o.onSorted.call(o.table)},20)}function b(j){while(j.hasChildNodes()){j=j.firstChild}var i=j.nodeValue;return(i)?i:false}function a(t,n){var r=false,j,v=n.rows,q=0,u;while(r===false){u=v[q];if(u){j=u.cells[t];r=$.trim(b(j))}else{break}q++}var s=$.SSsort.parsers;if(r!==false){var o=$.SSsort.ipcount,k=s.length;for(var m=o;m<k;m++){if(s[m].is(r,j,n)){return s[m]}}for(m=1;m<o;m++){if(s[m].is(r,j,n)){return s[m]}}}return s[0]}function g(m){var o=$.SSsort.parsers,q=$.SSsort.ipcount,j=o.length,k=m.toLowerCase();for(var n=q;n<j;n++){if(o[n].id.toLowerCase()==k){return o[n]}}for(n=0;n<q;n++){if(o[n].id.toLowerCase()==k){return o[n]}}return false}function f(l,i){var m=false;if($.metadata){var k=$(l).metadata().sss;if(k===false){return false}else{if(k){m=g(k)}}}if(!m){var j=l.cellIndex;m=a(j,i)}return m}this.defaults={sortClass:null,ascClass:null,descClass:null,evenClass:null,oddClass:null,evensortClass:null,oddsortClass:null,firstsort:null,sortdesc:false,paginate:false,pagesize:20,currentid:null,countid:null,onSorted:null};this.parsers=[{id:"text",is:function(i){return true},format:function(i){return $.trim(i)},type:"text"},{id:"number",is:function(i){return(!isNaN(parseFloat(i))&&isFinite(i))},format:function(i){if(i){var j=Number(i);return(isNaN(j))?Number.NEGATIVE_INFINITY:j}else{if((i+"").length>0){return 0}else{return Number.POSITIVE_INFINITY}}},type:"numeric"},{id:"isoDate",is:function(i){p=/^[12]\d{3}[\/-][01]\d[\/-]\[0-3]\d$/;return p.test(i)},format:function(i){return Date.parse(i.replace(/-/g,"/"))},type:"numeric"}];this.ipcount=this.parsers.length;this.construct=function(i){var j={table:null,header:null,body:null,rows:null,sortcol:null,sortdata:[],currentpage:1,pagecount:1,works:[]};this.each(function(){var l=$.extend({},j,$.SSsort.defaults,i||{});l.table=this;var q=$(this);l.header=q.children("thead");l.body=q.children("tbody");l.rows=l.body[0].rows;l.works=[];var k=l.header.find("tr:first > th");var n=$.fn.jquery;var o=$.metadata;var m=0;k.each(function(){var s=$(this);var r=s.hasClass("nosort");if(!r&&o){if(s.metadata().sss===false){r=true}}if(!r){var t=f(this,l);if(t){l.works[m]={parser:t,dirty:true,_map:[]};if(l.rows.length>1&&l.sortClass){s.addClass(l.sortClass)}if(n>="1.7"){s.on("click",h)}else{s.bind("click",h)}}}m++});$.data(this,"SSsortcfg",l);if(l.firstsort!==null){$cell=k.eq(l.firstsort-1);skip=$cell.hasClass("nosort");if(!skip&&o){if($cell.metadata().sss===false){skip=true}}if(skip){l.firstsort=null}else{$cell.trigger("click")}}if(l.firstsort===null&&l.paginate){d(l);c(0,l);if(l.countid){$("#"+l.countid).html(l.pagecount)}}});return this};this.movePage=function(k,m,j){var i=$.data(k,"SSsortcfg");if(i){var l=(m)?((j)?i.pagecount:i.currentpage+1):((j)?1:i.currentpage-1);if(l>0&&l<=i.pagecount){i.currentpage=l;c((l-1)*i.pagesize,i)}}};this.setCurrent=function(k,l,j){var i=$.data(k,"SSsortcfg");if(i){i[l]=j;c(0,i);if(i.countid){d(i);$("#"+i.countid).html(i.pagecount)}}};this.mapTable=function(k){var i={};var j=1;$(k).find("tr").each(function(){var l=this.getAttribute("id")||this.getAttribute("name")||"row"+j;var n={};var m=1;$(this).each(function(){var q=[];$(this).children().each(function(){q[q.length]=(this.hasAttribute("value"))?this.getAttribute("value"):$(this).text()});var s=this.atgetAttribute("id")||this.getAttribute("name")||"col"+m;switch(q.length){case 0:n[s]="<empty>";break;case 1:n[s]=q[0];break;default:var r={};for(var o=0;o<q.length;++o){r[o]=q[o]}n[s]=r;break}m++});i[l]=n;j++});return i};this.addParser=function(q,o){var n=q.id.toLowerCase();var m=$.SSsort.parsers;var j=m.length;for(var k=0;k<j;k++){if(m[k].id.toLowerCase()==n){if(o){m[k]=q}return}}m[j]=q};this.formatFloat=function(i){var j=parseFloat(i);return(isNaN(j))?Number.NEGATIVE_INFINITY:j};this.formatInt=function(i){var j=parseInt(i,10);return(isNaN(j))?Number.NEGATIVE_INFINITY:j}}});$.fn.extend({SSsort:$.SSsort.construct})})(jQuery);