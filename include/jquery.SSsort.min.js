/*!
SSsort table-sorter/pager plug-in for JQuery
Version 0.3
Copyright (C) 2014-2015 Tom Phane
Licensed under the GNU Affero GPL v.3 or, at the distributor's discretion, a later version.
See http://www.gnu.org/licenses#AGPL.
*/
(function($){$.extend({SSsort:new function(){function d(i){i.pagecount=((i.rows.length/i.pagesize)|0)+1}function c(k,j){var o=parseInt(j.pagesize,10);if(j.currentid){if(o<1){j.currentpage=1}else{j.currentpage=((k/o)|0)+1}$("#"+j.currentid).html(j.currentpage)}var n=j.rows;if(o<1){o=n.length+1}var m=k+o;for(var l=0;l<n.length;l++){n[l].style.display=(l>=k&&l<m)?"":"none"}}function e(s){var m=s.works[s.sortcol];var j=m.parser.format;var u=s.rows;var q=u.length;var t=s.sortcol;var o=[];var n;for(var r=0;r<q;r++){n=u[r].cells[t];o[r]=[j(b(n),n,s),r]}var k;if(m.parser.type=="text"){k=(s.sortdesc)?function(l,i){return(i[0].localeCompare(l[0]))}:function(l,i){return(l[0].localeCompare(i[0]))}}else{k=(s.sortdesc)?function(l,i){return(i[0]-l[0])}:function(l,i){return(l[0]-i[0])}}m._map=o.sort(k)}function h(q){var n=q.data;if(n.rows.length<2){return}var k=this.cellIndex;var v=n.header.find("tr:first > th");var j=0;if(k>0){for(var m=0;m<k;m++){var u=v[m];if(u.hasAttribute("colspan")){var t=u.getAttribute("colspan");j+=parseInt(t,10)||1}else{j++}}}var r=null;if(j==n.sortcol){var o=(n.sortdesc)?n.descClass:n.ascClass;n.sortdesc=!n.sortdesc;var s=(n.sortdesc)?n.descClass:n.ascClass;if(o){v.eq(j).removeClass(o)}if(s){v.eq(j).addClass(s)}$(n.table).trigger("beforetablesort",{column:j,direction:n.sortdesc});if(n.works[j].dirty){e(n)}else{n.works[j]._map.reverse()}}else{if(n.sortcol!==null){r=n.sortcol;o=(n.sortdesc)?n.descClass:n.ascClass;if(o){v.eq(r).removeClass(o)}if(n.sortClass){v.eq(r).addClass(n.sortClass)}if(n.ascClass){v.eq(j).addClass(n.ascClass)}n.sortdesc=false}else{if(n.sortClass){v.eq(j).removeClass(n.sortClass)}s=(n.sortdesc)?n.descClass:n.ascClass;if(s){v.eq(j).addClass(s)}}n.sortcol=j;$(n.table).trigger("beforetablesort",{column:j,direction:n.sortdesc});e(n)}setTimeout(function(){var C=(n.oddClass)?new RegExp("(^|\\s+)"+n.oddClass+"(?!\\S)"):false;var G=(n.evenClass)?new RegExp("(^|\\s+)"+n.evenClass+"(?!\\S)"):false;var F=(n.oddClass)?new RegExp("(^|\\s+)"+n.oddsortClass+"(?!\\S)"):false;var w=(n.evenClass)?new RegExp("(^|\\s+)"+n.evensortClass+"(?!\\S)"):false;var D=n.body[0];var H=D.parentNode;var K=D.nextSibling;var J=n.rows;var y=J.length;var x=n.works[j]._map;var I,E,A,z;H.removeChild(D);for(var B=0;B<y;B++){A=x[B][1];I=J[A];u=I.cells[j];D.appendChild(I);if(B%2){if(C){I.className=I.className.replace(C,"")}if(G&&!I.className.match(G)){I.className=I.className+" "+n.evenClass}if(F){u.className=u.className.replace(F,"")}if(w&&!u.className.match(w)){u.className=u.className+" "+n.evensortClass}}else{if(G){I.className=I.className.replace(G,"")}if(C&&!I.className.match(C)){I.className=I.className+" "+n.oddClass}if(w){u.className=u.className.replace(w,"")}if(F&&!u.className.match(F)){u.className=u.className+" "+n.oddsortClass}}if(r!==null){E=I.cells[r];if(F){E.className=E.className.replace(F,"")}if(w){E.className=E.className.replace(w,"")}}x[B][1]=B;for(z=B+1;z<y;z++){if(x[z][1]>A){x[z][1]--}}}H.insertBefore(D,K);n.body=$(n.table).children("tbody");n.rows=D.rows;n.works[j].dirty=(typeof(n.works[j].parser.watch)!=="undefined"&&n.works[j].parser.watch);if(n.paginate){n.currentpage=1;d(n);c(0,n);if(n.countid){$("#"+n.countid).html(n.pagecount)}}$(n.table).trigger("aftertablesort",{column:j,direction:n.sortdesc});$.isFunction(n.onSorted)&&n.onSorted.call(n.table)},20)}function b(j){while(j.hasChildNodes()){j=j.firstChild}var i=j.nodeValue;return(i)?i:false}function a(t,n){var r=false,j,v=n.rows,q=0,u;while(r===false){u=v[q];if(u){j=u.cells[t];r=$.trim(b(j))}else{break}q++}var s=$.SSsort.parsers;if(r!==false){var o=$.SSsort.ipcount,k=s.length;for(var m=o;m<k;m++){if(s[m].is(r,j,n)){return s[m]}}for(m=1;m<o;m++){if(s[m].is(r,j,n)){return s[m]}}}return s[0]}function g(m){var o=$.SSsort.parsers,q=$.SSsort.ipcount,j=o.length,k=m.toLowerCase();for(var n=q;n<j;n++){if(o[n].id.toLowerCase()==k){return o[n]}}for(n=0;n<q;n++){if(o[n].id.toLowerCase()==k){return o[n]}}return false}function f(l,i){var m=false;if($.metadata){var k=$(l).metadata().sss;if(k===false){return false}else{if(k){m=g(k)}}}if(!m){var j=l.cellIndex;m=a(j,i)}return m}this.defaults={sortClass:null,ascClass:null,descClass:null,evenClass:null,oddClass:null,evensortClass:null,oddsortClass:null,firstsort:null,sortdesc:false,paginate:false,pagesize:20,currentid:null,countid:null,onSorted:null};this.parsers=[{id:"text",is:function(i){return true},format:function(i){return $.trim(i)},type:"text"},{id:"number",is:function(i){return(!isNaN(parseFloat(i))&&isFinite(i))},format:function(i){if(i){var j=Number(i);return(isNaN(j))?Number.NEGATIVE_INFINITY:j}else{if((i+"").length>0){return 0}else{return Number.POSITIVE_INFINITY}}},type:"numeric"},{id:"isoDate",is:function(i){p=/^[12]\d{3}[\/-][01]\d[\/-]\[0-3]\d$/;return p.test(i)},format:function(i){return Date.parse(i.replace(/-/g,"/"))},type:"numeric"}];this.ipcount=this.parsers.length;this.construct=function(i){var j={table:null,header:null,body:null,rows:null,sortcol:null,sortdata:[],currentpage:1,pagecount:1,works:[]};this.each(function(){var l={};$.extend(l,j,$.SSsort.defaults,i||{});$.data(this,"SSsortcfg",l);l.table=this;var o=$(this);l.header=o.children("thead");l.body=o.children("tbody");l.rows=l.body[0].rows;var k=l.header.find("tr:first > th");var n=$.fn.jquery;var m=0;k.each(function(){var q=$(this);if(!q.hasClass("nosort")){var r=f(this,l);if(r){l.works[m]={parser:r,dirty:true,_map:[]};if(l.rows.length>1&&l.sortClass){q.addClass(l.sortClass)}if(n>="1.7"){q.on("click.sss",l,h)}else{q.bind("click.sss",l,h)}}}m++});if(l.firstsort!==null){$cell=k.eq(l.firstsort-1);if(!$cell.hasClass("nosort")){$cell.trigger("click")}else{l.firstsort=null}}if(l.firstsort===null&&l.paginate){d(l);c(0,l);if(l.countid){$("#"+l.countid).html(l.pagecount)}}});return this};this.movePage=function(k,m,j){var i=$.data(k,"SSsortcfg");if(i){var l=(m)?((j)?i.pagecount:i.currentpage+1):((j)?1:i.currentpage-1);if(l>0&&l<=i.pagecount){i.currentpage=l;c((l-1)*i.pagesize,i)}}};this.setCurrent=function(k,l,j){var i=$.data(k,"SSsortcfg");if(i){i[l]=j;c(0,i);if(i.countid){d(i);$("#"+i.countid).html(i.pagecount)}}};this.mapTable=function(k){var i={};var j=1;$(k).find("tr").each(function(){var l=this.getAttribute("id")||this.getAttribute("name")||"row"+j;var n={};var m=1;$(this).each(function(){var q=[];$(this).children().each(function(){q[q.length]=(this.hasAttribute("value"))?this.getAttribute("value"):$(this).text()});var s=this.atgetAttribute("id")||this.getAttribute("name")||"col"+m;switch(q.length){case 0:n[s]="<empty>";break;case 1:n[s]=q[0];break;default:var r={};for(var o=0;o<q.length;++o){r[o]=q[o]}n[s]=r;break}m++});i[l]=n;j++});return i};this.addParser=function(q,o){var n=q.id.toLowerCase();var m=$.SSsort.parsers;var j=m.length;for(var k=0;k<j;k++){if(m[k].id.toLowerCase()==n){if(o){m[k]=q}return}}m[j]=q};this.formatFloat=function(i){var j=parseFloat(i);return(isNaN(j))?Number.NEGATIVE_INFINITY:j};this.formatInt=function(i){var j=parseInt(i,10);return(isNaN(j))?Number.NEGATIVE_INFINITY:j}}});$.fn.extend({SSsort:$.SSsort.construct})})(jQuery);