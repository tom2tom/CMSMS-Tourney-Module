/*!
TableDnD plug-in for JQuery
Version 0.8.1
* 
Copyright (C) 2014-2015 Tom Phane
Licensed under the GNU Affero GPL v.3 or, at the distributor's discretion, a later version.
See http://www.gnu.org/licenses#AGPL.
*/
(function($){$.extend({tableDnD:new function(){var n=$.fn.jquery;this.defaults={buttonState:"",containerID:null,dragClass:"tDnD_whileDrag",dragHandle:null,dragStyles:{color:"purple","font-style":"italic"},dropStyles:null,onAllowDrop:null,onDragStart:null,onDrop:null,onRowsChanged:null,filterRegexp:null};this.construct=function(s){var t={currentTable:null,dragBody:null,dragObject:null,bound:false,prepare:false,dragging:false,ptrOffset:null,firstY:0,oldY:0,upid:0,dnid:0,jqge14:false,jqge17:false};this.each(function(){var w=this.tBodies;if(!w){return}var z=0;for(var x=0;x<w.length;x++){z+=w[x].rows.length;if(z>1){break}}if(z<2){return}var v={};$.extend(v,t,$.tableDnD.defaults,s||{});v.currentTable=this;$.data(this,"tDnDconfig",v);var u;if(v.containerID){u=$("#"+v.containerID);if(u.length>0){var y=u.css("overflow");if(!(y=="auto"||y=="scroll")){v.containerID=null}}}if(!v.containerID){u=$(this).parent();y=u.css("overflow");if((y=="auto"||y=="scroll")){v.containerID=u.attr("id");if(!v.containerID){v.containerID="tDnDcontainerID";u.attr("id",v.containerID)}}}v.jqge17=versionCompare(n,"1.7")>=0;v.jqge14=v.jqge17||versionCompare(n,"1.4")>=0;if(v.jqge17){$(this).on("mouseover.tdnd","tbody",v,m).on("mouseout.tdnd","tbody",v,g)}else{for(x=0;x<w.length;x++){$(w[x]).bind("mouseover.tdnd",v,m).bind("mouseout.tdnd",v,g)}}});return this};this.mapTables=function(){var s="";this.each(function(){s+=r(this)});return s};function r(v){var t=$.data(v,"tDnDconfig");var s={};var u=1;$(v).find("tr").each(function(){var w=this.getAttribute("id")||this.getAttribute("name")||"row"+u;if(!t||!t.filterRegexp||w.match(t.filterRegexp)!==null){var y={};var x=1;$(this).each(function(){var A=[];$(this).children().each(function(){A[A.length]=(this.hasAttribute("value"))?this.getAttribute("value"):$(this).text()});var C=this.atgetAttribute("id")||this.getAttribute("name")||"col"+x;switch(A.length){case 0:y[C]="<empty>";break;case 1:y[C]=A[0];break;default:var B={};for(var z=0;z<A.length;++z){B[z]=A[z]}y[C]=B;break}x++});s[w]=y}u++});return s}function d(s){if(s.pageX||s.pageY){return{x:s.pageX,y:s.pageY}}var t=(document.documentElement&&document.documentElement.scrollLeft!==null)?document.documentElement:document.body;return{x:s.clientX+t.scrollLeft,y:s.clientY+t.scrollTop}}function j(v,u){u=u||window.event;var t=q(v);var s=d(u);return{x:s.x-t.x,y:s.y-t.y}}function q(u){var t=0;var s=0;if(u.offsetHeight===0){if(u.firstChild){u=u.firstChild}}while(u.offsetParent){t+=u.offsetLeft;s+=u.offsetTop;u=u.offsetParent}t+=u.offsetLeft;s+=u.offsetTop;return{x:t,y:s}}function i(){var s=0;if(window.pageYOffset){s=window.pageYOffset}else{if(window.scrollY){s=window.scrollY}else{var u;s=(((u=document.documentElement)||(u=document.body.parentNode))&&typeof u.ScrollTop=="number")?u.ScrollTop:document.body.ScrollTop}}return s}function c(){if(window.innerHeight&&window.scrollMaxY){return window.scrollMaxY}var s=(window.innerHeight)?window.innerHeight:document.body.clientHeight;if(document.body.scrollHeight>document.body.offsetHeight){return document.body.scrollHeight-s}else{return document.body.offsetHeight-s}}function f(u,y,x,s){var w;var z;if(y){var A=i();if(x){if(A>0){w=-1}else{s.upid=0;return}}else{z=c();if(A<z){w=1}else{s.dnid=0;return}}window.scrollBy(0,w)}else{w=$(u).scrollTop();if(x){if(w>0){w-=1}else{s.upid=0;return}}else{z=u.scrollHeight-u.clientHeight;if(w<z){w+=1}else{s.dnid=0;return}}u.scrollTop(w)}var v=setTimeout(function(){f(u,y,x,s)},20);if(x){s.upid=v}else{s.dnid=v}}function o(s){if(s.upid){window.clearTimeout(s.upid);s.upid=0}if(s.dnid){window.clearTimeout(s.dnid);s.dnid=0}}function h(v,t){if(t.dropStyles){var s={};for(var u in t.dropStyles){s[u]=""}$(v).css(s)}if(t.dragClass){$(v).addClass(t.dragClass)}if(t.dragStyles){$(v).css(t.dragStyles)}}function k(v,t){if(t.dragStyles){var s={};for(var u in t.dragStyles){s[u]=""}$(v).css(s)}if(t.dragClass){$(v).removeClass(t.dragClass)}}function b(y){var t=y.data;if(t.buttonState){var w;if(y.which===null){w=(y.button<2)?"0":((y.button===4)?"1":"2")}else{w=(y.which<2)?"0":((y.which===2)?"1":"2")}if(t.buttonState.indexOf(w)===-1){return false}if(t.buttonState.indexOf("shift")!==-1&&!y.shiftKey){return false}if(t.buttonState.indexOf("ctrl")!==-1&&!y.ctrlKey){return false}if(t.buttonState.indexOf("alt")!==-1&&!y.altKey){return false}if(t.buttonState.indexOf("meta")!==-1&&!y.metaKey){return false}}var x=y.target||y.srcElement||y.originalTarget;var v=x.nodeName.toLowerCase();switch(v){case"td":case"tr":break;case"tbody":case"input":case"select":case"a":return false;default:x=$(x).closest("td");if(x.length===0){return false}v="td";break}var z;var s;if(t.dragHandle){var u=$("td."+t.dragHandle,x);if(u.length>0){z=u[0].parentNode;if(!$(z).hasClass("nodrag")){s=$(z).parent("tbody")[0];if(s!==undefined){return{tb:s,ob:z}}}}}else{if(v=="td"){z=$(x).parent("tr")[0];if(z===undefined){return false}}else{z=x}if(!$(z).hasClass("nodrag")){s=$(z).parent("tbody")[0];if(s!==undefined){return{tb:s,ob:z}}}}return false}function m(t){var s=t.data;if(!s.draqgging){if(s.jqge17){$(this).on("mousemove.tdnd",s,e)}else{$(this).bind("mousemove.tdnd",s,e)}}return true}function g(t){var u=$(this);var s=t.data;if(!s.dragging){s.currentTable.style.cursor="default";if(s.jqge17){u.off("mousemove.tdnd",e)}else{u.unbind("mousemove.tdnd",e)}}if(s.bound){if(s.jqge17){u.off("mousedown.tdnd",l).off("dblclick.tdnd",p)}else{u.unbind("mousedown.tdnd",l).unbind("dblclick.tdnd",p)}s.bound=false}return true}function e(M){var x=M.data;var O=b(M);if(!x.prepare){if(O){if(!x.bound){x.currentTable.style.cursor="crosshair";if(x.jqge17){$(this).on("mousedown.tdnd",x,l).on("dblclick.tdnd",x,p)}else{if(x.jqge14){$(this).bind("mousedown.tdnd",x,l).bind("dblclick.tdnd",x,p)}else{$(this).bind("mousedown.tdnd",x,l)}}x.bound=true}}else{if(x.bound&&!x.dragging){x.currentTable.style.cursor="default";if(x.jqge17){$(this).off("mousedown.tdnd",l).off("dblclick.tdnd",p)}else{$(this).unbind("mousedown.tdnd",l).unbind("dblclick.tdnd",p)}x.bound=false}}return true}var J=d(M);if(Math.abs(J.y-x.firstY)<=3){return false}if(!x.dragging){if(O){if(x.dragBody){if(x.dragBody!=O.tb){$.each(x.dragObject,function(){k(this,x)});x.dragObject=null;x.dragBody=O.tb}}else{x.dragBody=O.tb}if(x.dragObject){if($.inArray(O.ob,x.dragObject)===-1){x.dragObject[x.dragObject.length]=O.ob;h(O.ob,x)}}else{x.dragObject=[O.ob];h(O.ob,x)}}if(x.dragObject===null){a(M);return true}$.unique(x.dragObject);var I=(O)?O.ob:x.dragObject[0];x.ptrOffset=j(I,M);x.dragging=true;x.oldY=x.firstY-x.ptrOffset.y;if(x.onDragStart){x.onDragStart(table,x.dragObject)}x.currentTable.style.cursor="row-resize";return true}var s;var u;var E=false;if(x.containerID){var F=$("#"+x.containerID);s=F.offset().top;if(J.y<s+5){if(x.upid===0){f(F[0],false,true,x)}E=true}else{u=s+F.outerHeight(true);if(J.y>u-5){if(x.dnid===0){f(F[0],false,false,x)}E=true}}}if(!E){s=i();if(J.y<s+5){if(x.upid===0){f(window,true,true,x)}E=true}else{u=s+$(window).height();if(J.y>u-5){if(x.dnid===0){f(window,true,false,x)}E=true}}}if(!E){o(x)}var C=J.y-x.ptrOffset.y;if(C!=x.oldY){var G=(C<x.oldY);var L=null;var H=$("> tr",x.dragBody);var K;for(K=0;K<H.length;K++){var B=H[K];var P;var t;if(B.offsetHeight>0){P=q(B).y;t=parseInt(B.offsetHeight,10)/2}else{P=q(B.firstChild).y;t=parseInt(B.firstChild.offsetHeight,10)/2}if((C>(P-t))&&(C<(P+t))){if($.inArray(B,x.dragObject)===-1){if(x.onAllowDrop){if(x.onAllowDrop(x.dragObject,B)){L=B}}else{if(!$(B).hasClass("nodrop")){L=B}}}break}}if(L){var v=[];$.each(H,function(y){if($(this).hasClass("nodrop")&&$.inArray(this,x.dragObject)==-1){v[v.length]=[y,this]}});if(G){$.each(x.dragObject,function(){if(this!=L){$(this).insertBefore(L)}else{var y=$(this).next();if(y.length){L=y[0]}}})}else{$.each(x.dragObject,function(){if(this!=L){$(this).insertAfter(L);L=this}else{var y=$(this).prev();if(y.length){L=y[0]}}})}var A=$("> tr",x.dragBody).eq(0);$.each(v,function(){if(this[1]!=A[0]){$(this[1]).insertBefore(A)}});var z=0;for(var N=0;N<v.length;N++){var w=v[N][0];if(w>z){var D=$("> tr",x.dragBody);$(D[z]).insertAfter($(D[w]))}else{z++}}if(x.onRowsChanged){x.onRowsChanged(this,x.dragObject,L)}}x.oldY=C}return false}function l(t){var s=t.data;s.prepare=true;s.firstY=d(t).y;if(s.jqge17){$(document).on("mouseup.tdnd",s,a)}else{$(document).bind("mouseup.tdnd",s,a)}return false}function a(t){var s=t.data;if(s.jqge17){$(document).off("mouseup.tdnd",a)}else{$(document).unbind("mouseup.tdnd",a)}s.prepare=false;s.firstY=0;if(s.dragging){if(s.dragObject){o(s);s.oldY=0;$.each(s.dragObject,function(){k(this,s)});if(s.dropStyles){$.each(s.dragObject,function(){$(this).css(s.dropStyles)})}s.currentTable.style.cursor="crosshair";if(s.onDrop){s.onDrop(s.currentTable,s.dragObject)}s.dragObject=null;s.dragBody=null}s.dragging=false;return false}}function p(u){var v=b(u);if(!v){return true}var t=u.data;if(t.dragBody){if(t.dragBody!=v.tb){$.each(t.dragObject,function(){k(this,t)});t.dragObject=null;t.dragBody=v.tb}}else{t.dragBody=v.tb}if(t.dragObject){var s=$.inArray(v.ob,t.dragObject);if(s!==-1){k(t.dragObject[s],t);if(t.dragObject.length==1){t.dragObject=null}else{t.dragObject.splice(s,1)}}else{if(!$(v.ob).hasClass("nodrag")){t.dragObject[t.dragObject.length]=v.ob;h(v.ob,t)}}}else{if(!$(v.ob).hasClass("nodrag")){t.dragObject=[v.ob];h(v.ob,t)}}return false}versionCompare=function(x,w){if(typeof x+typeof w!="stringstring"){return false}var u=x.split("."),t=w.split("."),v=0,s=Math.max(u.length,t.length);for(;v<s;v++){if((u[v]&&!t[v]&&parseInt(u[v])>0)||(parseInt(u[v])>parseInt(t[v]))){return 1}else{if((t[v]&&!u[v]&&parseInt(t[v])>0)||(parseInt(u[v])<parseInt(t[v]))){return -1}}}return 0}}});$.fn.extend({tableDnD:$.tableDnD.construct})})(jQuery);